# –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã Telegram-–±–æ—Ç–∞

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –±–æ—Ç–æ–º –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —à–∞–≥–∏ —Å–∏—Å—Ç–µ–º—ã.

## –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
1. –ë–æ—Ç —á–∏—Ç–∞–µ—Ç `ADMIN_ID` –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (`app/config.py`).
2. –í—Å–µ –∞–ø–¥–µ–π—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ `AdminAccessMiddleware`, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç `from_user.id` —Å `ADMIN_ID`.
3. –ï—Å–ª–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç:
   - Middleware –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω¬ª.
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è; —Å–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É.
4. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ö–µ–Ω–¥–ª–µ—Ä–∞–º.

## –ö–æ–º–∞–Ω–¥–∞ `/start`
1. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `/start` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `app/bot/handlers/admin.py::cmd_start`.
2. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–º ¬´üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è VPN.¬ª.
3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è inline-–º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏:
   - ¬´üîë –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á¬ª
   - ¬´üìã –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π¬ª (–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é)
   - ¬´üóë –£–¥–∞–ª–∏—Ç—å –∫–ª—é—á¬ª
   - ¬´‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª
4. –ö–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç callback-—Ö–µ–Ω–¥–ª–µ—Ä –≤ `key_management.py`.

## –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ (callback `create_key`)
1. `handle_create_key` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç UUID (`uuid4`) –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç email-—à–∞–±–ª–æ–Ω `user_<tg_id>@vpn.local`.
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É XRay –∏–∑ `XRAY_CONFIG_PATH`.
3. –§—É–Ω–∫—Ü–∏—è `services.xray.create_client`:
   - —á–∏—Ç–∞–µ—Ç `config.json`;
   - –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ inbound –∫–ª–∏–µ–Ω—Ç–∞ —Å –Ω–æ–≤—ã–º UUID;
   - —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç vless-—Å—Å—ã–ª–∫—É –≤–∏–¥–∞ `vless://<uuid>@<XRAY_HOST>:<XRAY_PORT>?...#email`.
4. `_store_key` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∫–ª—é—á –≤ —Ç–∞–±–ª–∏—Ü—É `keys` PostgreSQL.
5. `reload_xray()` –≤—ã–∑—ã–≤–∞–µ—Ç `systemctl reload xray` (–≤ —Ç–µ—Å—Ç–∞—Ö –ø–æ–¥–º–µ–Ω—è–µ—Ç—Å—è).
6. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É:
   - —Ç–µ–∫—Å—Ç ¬´‚úÖ –ö–ª—é—á —Å–æ–∑–¥–∞–Ω¬ª —Å vless-—Å—Å—ã–ª–∫–æ–π;
   - —Ñ–∞–π–ª QR-–∫–æ–¥–∞ (PNG) —Å –ø–æ–¥–ø–∏—Å—å—é ¬´QR-–∫–æ–¥ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è¬ª.

## –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ (callback `delete_key:<uuid>`)
1. –•–µ–Ω–¥–ª–µ—Ä –ø–∞—Ä—Å–∏—Ç UUID –∏–∑ `callback.data`.
2. `services.xray.remove_client` —É–¥–∞–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ XRay (–µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω).
3. `_delete_key_record` —É–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `keys`.
4. `reload_xray()` –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç XRay.
5. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:
   - Alert ¬´–ö–ª—é—á —É–¥–∞–ª—ë–Ω¬ª;
   - —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´üóë –ö–ª—é—á <uuid> —É–¥–∞–ª—ë–Ω¬ª.
6. –ï—Å–ª–∏ UUID –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –±–æ—Ç —Å–æ–æ–±—â–∞–µ—Ç –æ–± –æ—à–∏–±–∫–µ.

## –ü–æ–¥—Å–∫–∞–∑–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (callback `delete_key`)
1. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç alert ¬´–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª—é—á –∏–∑ —Å–ø–∏—Å–∫–∞¬ª (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –¥–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ —Å –∏–Ω–ª–∞–π–Ω-—Å–ø–∏—Å–∫–æ–º).

## –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∏—Å—Ç–µ—á–µ–Ω–∏—è
1. `scheduler.remove_expired_keys` –≤—ã–±–∏—Ä–∞–µ—Ç –∫–ª—é—á–∏, –≥–¥–µ `expires_at <= now`.
2. –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –∏–∑ –ë–î –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö UUID.
3. `scheduler.scheduler_loop` —Å –∑–∞–¥–∞–Ω–Ω—ã–º `interval_seconds` —Ü–∏–∫–ª–∏—á–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—á–∏—Å—Ç–∫—É.

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
1. `limiter.parse_active_ips` –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç `access.log` –≤ –ø–æ–∏—Å–∫–µ —Å—Ç—Ä–æ–∫ –≤–∏–¥–∞ `uuid=<uuid> ip=<ip>`.
2. `limiter.detect_overuse` –Ω–∞—Ö–æ–¥–∏—Ç –∫–ª—é—á–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö IP-–∞–¥—Ä–µ—Å–æ–≤ > –ª–∏–º–∏—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3).
3. `limiter.handle_overuse` –≤—ã–∑—ã–≤–∞–µ—Ç `apply_tc_limit` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è.
4. –í —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ tc —Å–Ω–∏–∂–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å, –≤ —Ç–µ—Å—Ç–∞—Ö –≤—ã–∑–æ–≤ –º–æ–∫–∏—Ä—É–µ—Ç—Å—è.

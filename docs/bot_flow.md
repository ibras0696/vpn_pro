# –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã Telegram-–±–æ—Ç–∞

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –±–æ—Ç–æ–º –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —à–∞–≥–∏ —Å–∏—Å—Ç–µ–º—ã.

## –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
1. –ë–æ—Ç —á–∏—Ç–∞–µ—Ç `ADMIN_ID` –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (`app/config.py`).
2. –í—Å–µ –∞–ø–¥–µ–π—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ `AdminAccessMiddleware`, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç `from_user.id` —Å `ADMIN_ID`.
3. –ï—Å–ª–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç:
   - Middleware –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω¬ª.
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è; —Å–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É.
4. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ö–µ–Ω–¥–ª–µ—Ä–∞–º.

## –ö–æ–º–∞–Ω–¥–∞ `/start`
1. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `/start` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `app/bot/handlers/admin.py::cmd_start`.
2. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–º ¬´üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è VPN.¬ª.
3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è inline-–º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏:
   - ¬´üîë –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á¬ª
   - ¬´üìã –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π¬ª
   - ¬´üóë –£–¥–∞–ª–∏—Ç—å –∫–ª—é—á¬ª
   - ¬´‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª
4. –ö–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç callback-—Ö–µ–Ω–¥–ª–µ—Ä –≤ `key_management.py`.
5. –ö–æ–º–∞–Ω–¥–∞ `/help` –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–º–∏–Ω—É—è middleware) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø—Ä–∞–≤–∫—É —Å –ø—Ä–∏–º–µ—Ä–æ–º vless-—Å—Å—ã–ª–∫–∏.

## –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ (callback `create_key`)
1. –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è ¬´–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á¬ª –±–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–≥–æ—Ç–æ–≤–∫—É (email `user_<tg_id>@vpn.local`, –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É) –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (1/7/30 –¥–Ω–µ–π –∏–ª–∏ ¬´–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è¬ª).
2. –í—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `expires_at` (UTC) –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ in-memory `PENDING_CREATIONS`.
3. –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî –≤—ã–±–æ—Ä –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (1/3/5 –∏–ª–∏ ¬´–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è¬ª).
4. –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –±–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `services.xray.create_client`, –æ–±–Ω–æ–≤–ª—è–µ—Ç `docker/xray/config.json`, —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç vless-—Å—Å—ã–ª–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î (`Key` —Å `expires_at`, `device_limit`).
5. `reload_xray()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥–æ—Å—Ç—É–ø–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `systemctl reload xray`, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å `XRAY_RELOAD_COMMAND`).
6. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç:
   - —Ç–µ–∫—Å—Ç ¬´‚úÖ –ö–ª—é—á —Å–æ–∑–¥–∞–Ω¬ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ä–æ–∫–µ/–ª–∏–º–∏—Ç–µ;
   - —Ñ–∞–π–ª QR-–∫–æ–¥–∞ (PNG) —Å –ø–æ–¥–ø–∏—Å—å—é ¬´QR-–∫–æ–¥ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è¬ª.

## –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ (callback `delete_key:<uuid>`)
1. –•–µ–Ω–¥–ª–µ—Ä –ø–∞—Ä—Å–∏—Ç UUID –∏–∑ `callback.data`.
2. `services.xray.remove_client` —É–¥–∞–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ XRay (–µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω).
3. `_delete_key_record` —É–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `keys`.
4. `reload_xray()` –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç XRay (–µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞).
5. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:
   - Alert ¬´–ö–ª—é—á —É–¥–∞–ª—ë–Ω¬ª;
   - —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´üóë –ö–ª—é—á <uuid> —É–¥–∞–ª—ë–Ω¬ª.
6. –ï—Å–ª–∏ UUID –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –±–æ—Ç —Å–æ–æ–±—â–∞–µ—Ç –æ–± –æ—à–∏–±–∫–µ.

## –ü–æ–¥—Å–∫–∞–∑–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (callback `delete_key`)
1. –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –≤—Å–µ –∫–ª—é—á–∏ –∏–∑ –ë–î –∏ —Å—Ç—Ä–æ–∏—Ç inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É `delete_key:<uuid>`.
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω—É–∂–Ω—ã–π UUID, –ø–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Å—Ü–µ–Ω–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω–∏—è.

## –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∏—Å—Ç–µ—á–µ–Ω–∏—è
1. `scheduler.remove_expired_keys` –≤—ã–±–∏—Ä–∞–µ—Ç –∫–ª—é—á–∏, –≥–¥–µ `expires_at <= now`.
2. –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –∏–∑ –ë–î –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö UUID.
3. `scheduler.scheduler_loop` —Å –∑–∞–¥–∞–Ω–Ω—ã–º `interval_seconds` —Ü–∏–∫–ª–∏—á–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—á–∏—Å—Ç–∫—É.

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
1. `limiter.parse_active_ips` –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç `access.log` –≤ –ø–æ–∏—Å–∫–µ —Å—Ç—Ä–æ–∫ –≤–∏–¥–∞ `uuid=<uuid> ip=<ip>`.
2. `limiter.detect_overuse` –Ω–∞—Ö–æ–¥–∏—Ç –∫–ª—é—á–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö IP-–∞–¥—Ä–µ—Å–æ–≤ > –ª–∏–º–∏—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3).
3. `limiter.handle_overuse` –≤—ã–∑—ã–≤–∞–µ—Ç `apply_tc_limit` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è.
4. –í —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ tc —Å–Ω–∏–∂–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å, –≤ —Ç–µ—Å—Ç–∞—Ö –≤—ã–∑–æ–≤ –º–æ–∫–∏—Ä—É–µ—Ç—Å—è.

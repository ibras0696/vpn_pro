# Настройка `docker/xray/config.json`

## Общий вид

Бот работает с конфигурацией XRay (VLESS-инстанс). Файл `docker/xray/config.json` будет монтирован в контейнер бота, и 
каждый созданный или удалённый ключ обновляет блок `clients`. Структура примера:

```json
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "tag": "vless-in",
      "listen": "0.0.0.0",
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": []
      },
      "decryption": "none",
      "streamSettings": {
        "network": "tcp",
        "security": "none"
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "tag": "direct"
    }
  ]
}
```

### Важные поля

- `inbounds[0].protocol` — должен быть `vless`.
- `inbounds[0].settings.clients` — список, куда бот будет добавлять элементы вида:

  ```json
  {
    "id": "uuid-пользователя",
    "email": "user@example.com"
  }
  ```

- `port`, `security`, `streamSettings` — должны соответствовать реальной конфигурации XRay-core.
  - Для «чистого» TCP без сертификатов укажите `network: "tcp"` и `security: "none"` (как в примере).
  - Для gRPC с TLS переключите `network` в `"grpc"`, задайте `security: "tls"` и добавьте `tlsSettings` / `grpcSettings` (см. ниже).
- `log.loglevel` — произвольный; оставлен `warning`.

Если XRay-классическая конфигурация ждёт другие поля (например, `decryption` или `fallbacks`), их можно добавить в этот файл вручную — бот инжектирует только блок `clients`, остальные разделы не трогает.

## Связка с ботовым окружением

- Путь к файлу задаётся переменной `XRAY_CONFIG_PATH` (по умолчанию `./docker/xray/config.json`, внутри контейнера можно монтировать куда удобно, например `/app/xray/config.json`).
- При создании ключа бот добавляет в массив `clients` новую запись с `id=UUID` и `email=<почта>`.
- При удалении — удаляет запись по UUID.
- После изменений и при наличии рабочей команды в `XRAY_RELOAD_COMMAND` бот вызывает перезагрузку XRay (иначе нужно перезапускать службу вручную).
- Поля `XRAY_SECURITY`, `XRAY_NETWORK`, `XRAY_SERVICE_NAME`, `XRAY_FLOW` определяют параметры, которые бот добавляет в vless-ссылку. Они должны совпадать с настройками inbound’а (`security`, `streamSettings.network`, `grpcSettings.serviceName`, и т.д.).

## Рекомендации

1. **Проверяйте JSON** — конфигурация должна оставаться валидной. Бот пишет файл с отступами, но не проверяет корректность сертификатов или соответствие схеме.
2. **Backup** — перед тем как давать боту доступ к рабочему XRay-конфигу, сделайте резервную копию.
3. **Правильные разрешения** — XRay-core должен иметь доступ к файлу, с которым работает бот. Если конфиг лежит вне Docker, монтируйте его read/write в контейнер бота.
- **TLS / gRPC** — если используете защищённое соединение, допишите `tlsSettings` с путями к сертификатам и `grpcSettings` с `serviceName`. Для незашифрованного режима оставьте `security: "none"`.
5. **Несколько inbound-ов** — бот ищет первый inbound с `protocol: "vless"`. Если inbound-ов несколько, убедитесь, что нужный стоит первым или адаптируйте код (или конфигурацию) соответствующим образом.

После корректного настроя конфигурации и переменных окружения, мастер создания ключей сразу готов к работе: создаёт клиента, формирует ссылку и QR-код, фиксирует срок действия и лимит устройств в базе данных.

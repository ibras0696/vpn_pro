# VPN Project Bot

> –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Telegram-–±–æ—Ç –Ω–∞ Aiogram –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è VPN-–¥–æ—Å—Ç—É–ø–æ–º —á–µ—Ä–µ–∑ XRay-core.

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ VLESS-–∫–ª—é—á–µ–π —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π XRay;
- —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π –≤ PostgreSQL, —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º;
- –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –ø–æ access.log —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º `tc`-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º;
- –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å inline-–º–µ–Ω—é –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π `ADMIN_ID`;
- –≥–µ–Ω–µ—Ä–∞—Ü–∏—è vless-—Å—Å—ã–ª–æ–∫ –∏ QR-–∫–æ–¥–æ–≤ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –≤—ã–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   ```bash
   cp .env.example .env
   ```
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞:
   ```bash
   poetry install
   ```
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É:
   ```bash
   make up
   ```
4. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞:
   ```bash
   make logs
   ```

> ‚ùóÔ∏è –î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite, –∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö ‚Äî PostgreSQL.

## üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
| --- | --- |
| `DATABASE_URL` | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL (psycopg) |
| `BOT_TOKEN` | –¢–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞ |
| `ADMIN_ID` | Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ |
| `XRAY_CONFIG_PATH` | –ü—É—Ç—å –∫ `config.json` XRay |
| `XRAY_HOST` | –î–æ–º–µ–Ω –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è vless-—Å—Å—ã–ª–∫–∏ |
| `XRAY_PORT` | –ü–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–∞ XRay |
| `XRAY_RELOAD_COMMAND` | (–æ–ø—Ü–∏—è) –∫–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ XRay, –Ω–∞–ø—Ä–∏–º–µ—Ä `service xray restart` |

## üß∞ Make –∫–æ–º–∞–Ω–¥—ã
- `make init` ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ `.env` –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ Poetry;
- `make setup-server` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Ubuntu: –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, Docker/Compose/Poetry –∏ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–æ–≤;
- `make up` / `make down` / `make restart` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ docker-compose;
- `make ps` ‚Äî —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤;
- `make logs` ‚Äî –ª–æ–≥–∏ –±–æ—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏;
- `make lint` / `make fmt` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∞–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Ruff;
- `make test` ‚Äî –∑–∞–ø—É—Å–∫ pytest —Å –æ—Ç–∫–ª—é—á—ë–Ω–Ω—ã–º–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏;
- `make coverage` ‚Äî –æ—Ç—á—ë—Ç –ø–æ –ø–æ–∫—Ä—ã—Ç–∏—é;
- `make clean` ‚Äî –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞, –æ—Ç—á—ë—Ç–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤;
- `make clean-docker` ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–º–æ–≤.
- `make ubuntu-setup-script` ‚Äî —Å–æ–∑–¥–∞—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Å–∫—Ä–∏–ø—Ç `ubuntu24_setup.sh` –¥–ª—è —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Ubuntu¬†24.

### üìú –ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
chmod +x scripts/setup_server.sh
./scripts/setup_server.sh
```

–õ–∏–±–æ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å make-–æ–±—ë—Ä—Ç–∫–æ–π:

```bash
make setup-server
```

–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ø–∏—é —Å–∫—Ä–∏–ø—Ç–∞ –ø–æ–¥ Ubuntu¬†24 —Ä—è–¥–æ–º —Å –ø—Ä–æ–µ–∫—Ç–æ–º:

```bash
make ubuntu-setup-script
./ubuntu24_setup.sh
```

–ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É `docker`), –∑–∞—Ç–µ–º –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Å `make init` –∏ `make up`.

## üß™ –¢–µ—Å—Ç—ã –∏ –ø–æ–∫—Ä—ã—Ç–∏–µ
```bash
pytest -q --disable-warnings
python3 -m coverage run -m pytest
python3 -m coverage report
```
–ü–æ–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–æ–¥—É `app/` ‚Äî **92%**.

## üê≥ Docker-–æ–∫—Ä—É–∂–µ–Ω–∏–µ
- `docker/Dockerfile.bot` ‚Äî –æ–±—Ä–∞–∑ –±–æ—Ç–∞ (Poetry + Aiogram + –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è);
- `docker/Dockerfile.postgres` ‚Äî PostgreSQL —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π;
- `docker/xray/config.json` ‚Äî –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞ XRay —Å –ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º –∫–ª–∏–µ–Ω—Ç–æ–≤;
- `docker-compose.yml` ‚Äî –±–æ—Ç –∏ –±–∞–∑–∞, readiness-healthcheck, volume —Ö—Ä–∞–Ω–µ–Ω–∏—è.

> –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —É–∫–∞–∂–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã XRay –≤ `docker/xray/config.json` –∏/–∏–ª–∏ –≤ `.env` –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `XRAY_CONFIG_PATH`.

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```text
app/
  bot/
    handlers/        # /start, —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π
    services/        # XRay, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, –æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    keyboards/       # inline-–º–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    middlewares/     # –ø—Ä–æ–≤–µ—Ä–∫–∞ ADMIN_ID
  config.py          # Pydantic Settings + .env
  db.py              # Async SQLAlchemy + —Ñ–∞–±—Ä–∏–∫–∞ —Å–µ—Å—Å–∏–π
  models/            # User, Key
docker/              # Dockerfile'—ã –∏ init.sql
tests/               # unit –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
docs/                # —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `docs/setup.md` ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ;
- `docs/architecture.md` ‚Äî —Å—Ö–µ–º–∞ –º–æ–¥—É–ª–µ–π –∏ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö;
- `docs/testing.md` ‚Äî —á–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã.

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º
- [ ] `make up` ‚Äî –ø—Ä–æ–µ–∫—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –≤ Docker;
- [ ] `pytest` –∏ `coverage` –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫, –ø–æ–∫—Ä—ã—Ç–∏–µ ‚â• 80%;
- [ ] `ruff`/`flake8` ‚Äî –ª–∏–Ω—Ç–µ—Ä –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π (`ruff check .`).
